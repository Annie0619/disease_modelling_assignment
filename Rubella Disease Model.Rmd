---
title: "MMID: Rubella Disease Model"
author: "Andomei Smit: SMTAND051"
date: "30/09/2025"
output:
  bookdown::pdf_document2:
    toc: true
    toc_depth: 2
    fig_caption: true
    keep_tex: true
---


```{r setup, include=FALSE, warning=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(fig.pos = 'H')
library(dplyr)
library(tidyr)
library(readr)
#rm(list=ls())
```

# Step 1: Age bins, sexes, years, placeholders

```{r}
## ---- Reproducibility & core timeline ----
set.seed(123)  # only affects any random placeholders we might generate
start_year <- 2025
horizon    <- 10    # 10-year policy window
years      <- seq(start_year, length.out = horizon, by = 1)
```

```{r}
## ---- Define our age bins (Option B) ----
# Single-year: 0..14
single_years <- 0:14

# Five-year bands starting at 15: (15-19, 20-24, ..., 70-74) and then 75+
five_year_lowers <- seq(15, 70, by = 5)
five_year_uppers <- five_year_lowers + 4
# We'll treat 75+ as a single open-ended bin
open_upper <- Inf

# Build a tidy table of bins with labels and integer indices
age_bins_tbl <- tibble::tibble(
  bin_index = seq_along(c(single_years, five_year_lowers, 75)),
  # For label, use exact single-year labels for 0..14, then "15-19", ..., "70-74", and "75+"
  label     = c(
    as.character(single_years),
    paste0(five_year_lowers, "-", five_year_uppers),
    "75+"
  ),
  lower     = c(single_years, five_year_lowers, 75),
  upper     = c(single_years, five_year_uppers, open_upper)  # upper is inclusive for single years
)

# For convenience, identify which bins fall inside female 15–44 (CRS-relevant window)
age_bins_tbl <- age_bins_tbl %>%
  mutate(
    # We'll use approximate logic: a bin is "CRS_relevant" if any age within it intersects 15..44
    CRS_relevant = (lower <= 44 & upper >= 15)
  )

age_bins_tbl
```

```{r}

```


```{r}



## ---- Define sexes ----
sex_levels <- c("F", "M")

## ---- Step 1e: Placeholder population-by-age (unbinned), by sex and year ----
# In practice, you'll replace this with UN WPP or Stats SA data, e.g.:
# columns: year, age (0..100), sex (F/M), pop (counts)

# We'll create a simple synthetic population that:
# - declines slowly with age,
# - is slightly larger for F in older ages (reflecting longevity),
# - is stable across years for now (we'll allow change later if desired).

max_age <- 100

pop_base_by_age <- tibble::tibble(
  age = 0:max_age,
  # Start with a notional shape (peak in younger ages, tapering with age)
  base = 1e6 * exp(-age / 60)  # purely illustrative shape
)

# Expand by sex with a small sex factor (more F at older ages)
sex_factors <- tibble::tibble(sex = sex_levels, factor = c(1.00, 0.98))
pop_unbinned <- tidyr::expand_grid(
  year = years,
  sex  = sex_levels,
  pop_base_by_age
) %>%
  left_join(sex_factors, by = "sex") %>%
  mutate(
    pop = base * factor
  ) %>%
  select(year, age, sex, pop)

# (Optional) You can add gentle year growth or cohort effects later if you wish.

## ---- Step 1f: Placeholder births by year (total) ----
# Real: use WPP/Stats SA series. Placeholder: ~1,000,000 births/year with small variation.
births_tbl <- tibble::tibble(
  year         = years,
  births_total = round(1e6 + 20000 * sin(2 * pi * (year - years[1]) / 5))  # tiny oscillation, arbitrary
)

## ---- Step 1g: Placeholder coverage ----
# Routine coverage: percentage at ~age-1 (apply annually)
# Catch-up: one-time coverage in start_year for ages 9m–14y (we'll operationalize to bins later)
coverage_tbl <- tibble::tibble(
  year               = years,
  routine_coverage   = 0.90,   # 90% every year (edit later)
  catchup_coverage   = dplyr::if_else(year == start_year, 0.90, NA_real_)  # 90% in campaign year only
)

## ---- Step 1h: Placeholder reported cases (for NB fitting later) ----
# Real: national annual totals (both sexes). Placeholder: noisy series.
cases_tbl <- tibble::tibble(
  year                = years,
  cases_reported_total = c(1200, 1500, 1100, 1300, 900, 1600, 1400, 1000, 1150, 980)
)

## ---- Step 1i: Placeholder pregnancy prevalence by single-year age (15..44) ----
# Real: derive from DHS/WPP (fertility → pregnancy prevalence). Placeholder: a simple hump.
preg_prev_tbl <- tibble::tibble(
  age  = 15:44,
  prev = dplyr::case_when(
    age < 20 ~ 0.06,        # 6% in late teens (illustrative)
    age < 25 ~ 0.12,        # 12% in early 20s
    age < 30 ~ 0.16,        # peak ~16%
    age < 35 ~ 0.13,
    age < 40 ~ 0.08,
    TRUE     ~ 0.04
  )
)

## ---- Step 1j: Helper to map single-year ages into our bins ----
# Given an integer age, return the bin_index in age_bins_tbl
map_age_to_bin <- function(age_vec, bins_tbl = age_bins_tbl) {
  # For each age, find the row where lower <= age <= upper (with 75+ handled by upper=Inf)
  sapply(age_vec, function(a) {
    idx <- which(bins_tbl$lower <= a & a <= bins_tbl$upper)[1]
    if (is.na(idx)) NA_integer_ else idx
  })
}

# Quick sanity check: 0, 14, 15, 44, 75, 99
test_ages <- c(0, 14, 15, 44, 75, 99)
cbind(age = test_ages, bin_index = map_age_to_bin(test_ages), label = age_bins_tbl$label[map_age_to_bin(test_ages)])

## ---- Step 1k: (Optional) Aggregate the unbinned population into our bins now ----
# This is a preview of what we will do before running the ODEs.
pop_binned <- pop_unbinned %>%
  mutate(bin_index = map_age_to_bin(age)) %>%
  filter(!is.na(bin_index)) %>%
  group_by(year, sex, bin_index) %>%
  summarise(pop = sum(pop), .groups = "drop") %>%
  left_join(age_bins_tbl, by = "bin_index") %>%
  arrange(year, sex, bin_index)

# Show a few rows so you can see the structure
head(pop_binned, 12)
```

